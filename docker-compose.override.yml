services:
  php:
    entrypoint: ["sh", "-lc", "mkdir -p /var/www/var/cache /var/www/var/log && chown -R www-data:www-data /var/www/var && exec docker-php-entrypoint php-fpm"]
    environment:
      APP_ENV: dev
      APP_DEBUG: 1
      COMPOSER_ALLOW_SUPERUSER: 1
      XDEBUG_MODE: develop,debug
      XDEBUG_CONFIG: client_host=host.docker.internal client_port=9003
      MESSENGER_TRANSPORT_DSN: redis://redis:6379/messages
      DATABASE_URL: mysql://symfony:symfony@db:3306/app?serverVersion=8.4&charset=utf8mb4
    build:
      context: .
      dockerfile: docker/php/Dockerfile
      args:
        INSTALL_XDEBUG: "true"
    volumes:
      - ./:/var/www:delegated
      - symfony_var:/var/www/var
      - ./docker/php/conf.d/xdebug.ini:/usr/local/etc/php/conf.d/zz-xdebug.ini:ro

  worker:
    entrypoint: ["sh", "-lc", "mkdir -p /var/www/var/cache /var/www/var/log && chown -R www-data:www-data /var/www/var && exec php bin/console messenger:consume async -vv"]
    build:
      context: .
      dockerfile: docker/php/Dockerfile
      args:
        INSTALL_XDEBUG: "true"
    environment:
      APP_ENV: dev
      APP_DEBUG: 1
      COMPOSER_ALLOW_SUPERUSER: 1
      MESSENGER_TRANSPORT_DSN: redis://redis:6379/messages
      DATABASE_URL: mysql://symfony:symfony@db:3306/app?serverVersion=8.4&charset=utf8mb4
    volumes:
      - ./:/var/www:delegated
      - symfony_var:/var/www/var

  nginx:
    volumes:
      - ./:/var/www:ro
    environment:
      APP_ENV: dev

  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    ports:
      - "8081:80"
    environment:
      PMA_USER: root
      PMA_PASSWORD: root
      PMA_HOST: db
      PMA_PORT: 3306
    depends_on:
      db:
        condition: service_healthy
    restart: unless-stopped

volumes:
  symfony_var: